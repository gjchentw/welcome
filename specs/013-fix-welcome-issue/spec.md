# Feature Specification: 修正無法 welcome 玩家的問題

**Feature Branch**: `013-fix-welcome-issue`  
**Created**: 2026-02-16  
**Status**: Draft  
**Input**: User description: "修正無法 welcome 玩家的問題"

**注意**: 本規格文件的所有內容都應遵循 `.specify/memory/constitution.md` 中定義的專案憲法原則。


## 使用者情境與測試 (User Scenarios & Testing) (必填)

### 使用者故事 1 - 歡迎被白名單阻擋的新玩家 (優先級: P1)

當一個不在白名單上的新玩家嘗試連線至伺服器時，伺服器應能識別該玩家，並允許在線上的玩家透過 `/welcome` 指令對其進行投票，即使該玩家從未成功登入過。

**優先級原因**: 這是本修正的核心目的，解決目前系統無法對新玩家進行白名單投票的阻礙。

**獨立測試方法**: 
1. 讓一個不在白名單上的帳號嘗試連線（預期被拒絕）。
2. 在線上的玩家嘗試輸入 `/welcome <該帳號名稱>`。
3. 觀察系統是否正確受理投票，而非顯示「玩家從未造訪過」的錯誤訊息。

**驗收場景 (Acceptance Scenarios)**:

1. **Given (已知)** 玩家 A 不在白名單上且從未登入過，**When (當)** 玩家 A 嘗試連線被拒後，線上玩家 B 執行 `/welcome A`，**Then (則)** 系統應開始對 A 進行投票流程。
2. **Given (已知)** 玩家 A 已在投票名單中，**When (當)** 玩家 B 再次執行 `/welcome A`，**Then (則)** 系統應提示玩家 B 已經投過票。

---

### 使用者故事 2 - 投票完成後自動加入白名單 (優先級: P2)

當針對某位被阻擋玩家的投票達到門檻時，該玩家應被自動加入伺服器白名單，使其下次連線時能順利登入。

**優先級原因**: 確保投票機制能實際達成「賦予白名單權限」的最終目的。

**獨立測試方法**: 
1. 對被阻擋的玩家進行投票直到達標。
2. 檢查伺服器白名單列表（`/whitelist list`）是否已包含該玩家。
3. 讓該玩家再次嘗試連線，驗證是否能成功進入。

**驗收場景**:

1. **Given** 投票數已達門檻，**When** 最後一票投下時，**Then** 系統應廣播歡迎訊息，並將目標玩家加入白名單。

---

### 邊際情況 (Edge Cases)

- **重複登入嘗試**: 同一玩家多次嘗試被拒時，快取應只保留一筆記錄，且不應影響投票計數。
- **快取過期**: 被阻擋玩家的資訊是否需要永久保留？（預計隨伺服器重啟清除，或依據快取容量自動汰換）。
- **名稱變更**: 對於使用正版驗證的伺服器，應以 UUID 為準，避免名稱變更導致的投票混亂。

## 指令與權限 (Commands & Permissions) (必填)

### 指令 (Syntax)

- `/welcome <player>`: 對指定的玩家進行投票（包含已被白名單阻擋的玩家）。

### 權限 (Permission Nodes)

- `welcome.use`: 允許使用 `/welcome` 指令進行投票（預設: true）。

## 設定需求 (Configuration Requirements) (必填)

- **訊息自訂**: 
  - `target-invalid`: 修改或新增訊息，確保當玩家確實不存在於快取或歷史紀錄時才顯示。
  - `welcome-success`: 當投票成功受理時的提示。

## 需求規格 (Requirements) (必填)

### Functional Requirements

- **FR-001**: 系統必須在玩家嘗試登入階段（Pre-Login）捕捉玩家的名稱與 UUID。
- **FR-002**: 系統必須將未通過白名單檢查的玩家加入「待投票快取」中。
- **FR-003**: `/welcome` 指令在檢查玩家有效性時，必須同時檢查「歷史造訪紀錄」與「待投票快取」。
- **FR-004**: 當針對快取中玩家的投票達標後，系統必須執行白名單添加操作。
- **FR-005**: 系統必須確保投票邏輯對「已在白名單」的玩家維持既有的攔截機制（不允許對已在白名單的人投票）。

### Key Entities (include if feature involves data)

- **LoginAttemptCache**: 暫存嘗試登入但被拒絕的玩家資訊（Name, UUID）。

## Success Criteria (mandatory)

### Measurable Outcomes

- **SC-001**: 線上玩家能夠在目標新玩家嘗試登入失敗後的 10 秒內，透過指令對其發起投票。
- **SC-002**: 投票達標後，目標玩家在 1 秒內被加入伺服器白名單。
- **SC-003**: 整個流程中，無需管理員手動干預即可完成新玩家的白名單授予。
