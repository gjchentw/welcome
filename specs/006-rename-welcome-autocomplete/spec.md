# Feature Specification: Rename Welcome Command & Add Autocomplete

**Feature Branch**: `006-rename-welcome-autocomplete`  
**Created**: 2026-02-15  
**Version**: v1.0.1  
**Status**: Draft  
**Input**: User description: "修正指令為 /welcome ，並且支援 PlayerName 的 autocompletion"

**注意**: 本規格文件的所有內容都應遵循 `.specify/memory/constitution.md` 中定義的專案憲法原則。

## Clarifications

### Session 2026-02-16
- Q: 如何確保非同步更新任務不會發生重疊 (Overlap)？ → A: 每次更新前應檢查前次任務是否已完成，或直接使用單一執行緒的 Bukkit Scheduler 定時任務。
- Q: 字母排序是否區分大小寫？ → A: 採用不區分大小寫 (Case-Insensitive) 的字母順序。
- Q: 快取 100 名玩家的記憶體占用預估為何？ → A: 預估低於 1MB (100 個 UUID 與名稱字串)，對伺服器效能影響可忽略不計。
- Q: 如何驗證指令更名後，核心投票功能仍 100% 運作正常？ → A: 透過實作整合測試模擬指令執行，並驗證投票數據狀態變更。
- Q: 玩家更改 Minecraft 名稱後，系統應在何時反映於補全清單中？ → A: 在下一個非同步快取更新週期自動同步反映。
- Q: 當快取更新失敗時 (API 異常)，系統應如何處理現有快取？ → A: 立即清除現有快取並提示錯誤，以確保資料準確性。
- Q: 如何確保非同步快取更新與同步讀取之間的執行緒安全？ → A: 使用 `volatile` 修飾快取指標，並在更新時進行原子性的 List 替換。
- Q: 100ms 的反應時間要求，應在何種離線玩家規模下進行量測基準驗證？ → A: 在伺服器擁有至少 1,000 名離線玩家的極端情況下進行量測。
- Q: 「最近 3 天上線」的時間基準為何？ → A: 以每次非同步快取更新執行當下的系統時間 (System.currentTimeMillis()) 為準計算。
- Q: 當設定檔出現非法值 (如 max-players <= 0) 時，系統應如何處理？ → A: 自動回退至預設值 (100) 並在控制台輸出警告。
- Q: 快取清單的篩選與排序執行順序為何？ → A: 依最後上線時間選出前 100 人，再對這 100 人進行字母排序。
- Q: 若玩家在快取更新間隔內被加入白名單，系統應如何處理其補全建議？ → A: 等待下一次定時更新，允許短暫的快取延遲。
- Q: 當玩家誤用舊指令 /wellcome 時，系統應如何反應？ → A: 完全不處理，顯示 Minecraft 預設的指令不存在訊息。
- Q: 系統應使用何種機制來管理非同步快取任務的生命週期？ → A: 使用 Bukkit Scheduler (非同步任務) 管理，並在 onDisable 時取消。
- Q: 系統應如何獲取「已知玩家」清單？ → A: 使用 `Bukkit.getOfflinePlayers()` 並過濾出最近 3 天內有上線的玩家。
- Q: 為了避免遍歷所有玩家造成延遲，我們該如何實作 3 天內的過濾邏輯？ → A: 使用非同步工作定期快取 3 天內上線的名單於記憶體中。
- Q: 若符合條件的玩家超過 100 人，應優先快取哪些玩家？ → A: 優先保留最近期上線的玩家，且快取上限應可於設定檔調整。
- Q: 新的快取上限設定項應命名為何？ → A: 使用 `autocomplete.max-players` (預設值為 100)。

### Session 2026-02-15
- Q: 自動補完的條件為何？ → A: 僅限已加入過伺服器（已知）但尚未處於白名單內的玩家。
- Q: 自動補全是否包含離線玩家？ → A: 是，包含所有曾加入過但不在白名單內的玩家（不論是否在線）。
- Q: 是否需要 /welcome reload 指令？ → A: 不需要，已移除。
- Q: 補全清單如何排序？ → A: 依字母順序排列（符合 Minecraft 標準慣例）。
- Q: 此功能是否標誌著版本演進至 v1.0.1？ → A: 是，版本正式更新為 v1.0.1。
- Q: 權限節點是否也需要同步更名？ → A: 是，更名為 `welcome.use` 以與新指令拼寫一致。

## 使用者情境與測試 (User Scenarios & Testing) *(必填)*

### 使用者故事 1 - 更名為 /welcome (優先級: P1)

作為一名玩家，我希望使用 `/welcome <玩家名稱>` 而不是舊的 `/wellcome` 指令來對新玩家投下歡迎票，因為這更符合拼寫直覺。此變更將於 v1.0.1 版本生效。

**優先級原因**: 這是使用者需求的核心變更，直接影響使用者操作。

**獨立測試方法**: 透過在遊戲內輸入 `/welcome` 並觀察是否正確執行投票邏輯來驗證。

**驗收場景 (Acceptance Scenarios)**:

1. **Given (已知)** 插件版本已更新至 v1.0.1, **When (當)** 玩家輸入 `/welcome <玩家名稱>`, **Then (則)** 系統應正確執行投票邏輯。
2. **Given (已知)** 插件版本為 v1.0.1, **When (當)** 玩家輸入 `/wellcome <玩家名稱>`, **Then (則)** 系統應提示指令不存在 (Minecraft 預設 Unknown command)。

---

### 使用者故事 2 - 玩家名稱自動補全 (優先級: P1)

作為一名玩家，當我輸入 `/welcome ` 並按下 Tab 鍵時，我希望看到曾加入過但不在白名單內的玩家清單，以便我能快速選擇目標玩家。

**優先級原因**: 顯著提升使用者體驗，減少輸入錯誤的可能性。

**獨立測試方法**: 在輸入指令後按下 Tab 鍵，檢查建議清單是否包含所有符合條件的玩家，且清單依字母順序排列。

**驗收場景**:

1. **Given** 伺服器有曾加入但未入白名單的玩家, **When** 玩家輸入 `/welcome ` 並按下 Tab, **Then** 系統應顯示這些玩家的名稱。
2. **Given** 玩家輸入 `/welcome p`, **When** 按下 Tab, **Then** 系統應過濾並僅顯示名稱以 'p' 開頭且不在白名單內的已知玩家，且結果依字母順序排列。

---

### 邊際情況 (Edge Cases)

- **目標玩家離線**: 由於支援離線玩家補全，系統應能正確處理對目前離線之已知玩家的投票。
- **無權限補全**: 如果玩家沒有 `welcome.use` 權限，不應顯示補全清單。
- **已在白名單內**: 已在白名單內的玩家不應出現在補全建議中。
- **快取延遲**: 玩家被加入白名單後，可能會有短暫延遲（直到下個快取週期）才會從補全清單消失。
- **非法設定**: 若 `max-players` 設定非法（如 <= 0），系統應自動回退至預設值 100 並警告。

## 指令與權限 (Commands & Permissions) *(必填)*

### 指令 (Syntax)

- `/welcome <player>`: 對指定玩家投下一張歡迎票。

### 權限 (Permission Nodes)

- `welcome.use`: 允許使用 `/welcome <player>` 指令 (預設: true)。

## 設定需求 (Configuration Requirements) *(必填)*

- **指令移除**: 舊有的 `/wellcome` 指令將被完全移除，不保留作為別名。
- **新增設定項**: 
    - `autocomplete.max-players`: (Integer) 定義自動補全快取的玩家數量上限（預設：100）。若值非法 (<= 0)，系統將回退至 100 並警告。
- **非同步管理**: 系統必須使用 Bukkit Scheduler 管理非同步任務，並確保在 `onDisable` 時取消所有掛起任務。

## 需求規格 (Requirements) *(必填)*

### Functional Requirements

- **FR-001**: 系統必須將主指令從 `/wellcome` 更改為 `/welcome`。
- **FR-002**: 系統必須為 `/welcome` 指令實作 `TabCompleter` 介面。
- **FR-003**: 自動補全建議必須僅包含「已知（曾加入過）」且「尚未在白名單內」的玩家（包含離線玩家）。
- **FR-004**: 系統必須實作「非同步快取機制」，使用 Bukkit Scheduler 定期過濾出最近 3 天內上線的玩家並儲存於記憶體。所有非同步任務必須在插件停用時正確關閉。
- **FR-005**: 若玩家更改 Minecraft 名稱，系統應在下一個非同步快取週期自動 반영更名後的資訊。
- **FR-006**: 若非同步更新任務執行異常或傳回資料為空，系統必須清除現有快取，以防止提供過時或錯誤的補全資訊。
- **FR-007**: 快取清單必須使用 `volatile` 指標進行原子性替換，以確保非同步寫入與同步讀取之間的執行緒安全。
- **FR-008**: 快取清單必須優先依最後上線時間選出前 `max-players` 位玩家，再將此子集依字母順序排序。
- **FR-009**: 系統必須在 `onTabComplete` 觸發時，僅基於記憶體快取內容進行過濾，不執行任何 IO 操作。
- **FR-010**: 自動補全應支援動態過濾（根據已輸入的字元縮小範圍）。
- **FR-011**: 系統必須在 `plugin.yml` 中將版本號更新為 `1.0.1`。
- **FR-012**: 系統必須在 `plugin.yml` 中正確註冊新指令，並更新對應的權限節點。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者在遊戲中輸入 `/welcome ` 後按下 Tab，在伺服器擁有 1,000 名離線玩家的極端情況下，仍可在 100 毫秒內看到建議清單。
- **SC-002**: 所有不在白名單內的已知玩家名稱皆能正確出現在補全清單中。
- **SC-003**: 原有的投票功能在更換指令名稱後仍能 100% 正常運作，且必須通過自動化整合測試驗證。
