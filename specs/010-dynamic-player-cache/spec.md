# Feature Specification: Dynamic Player Cache for Autocomplete

**Feature Branch**: `010-dynamic-player-cache`  
**Created**: 2026-02-16  
**Status**: Draft  
**Input**: User description: "Tab 自動補全使用的快取不要用定時更新，當有不再白名單內的玩家訪問時，檢查此玩家是否已在快取，若無則加入快取。"

**注意**: 本規格文件的所有內容都應遵循 `.specify/memory/constitution.md` 中定義的專案憲法原則。

## 使用者情境與測試 (User Scenarios & Testing) *(必填)*

### 使用者故事 1 - 即時更新補全清單 (優先級: P1)

作為一名伺服器玩家，當我想對剛進入伺服器（但尚未在白名單內）的玩家進行投票時，我希望在輸入 `/welcome ` 後按下 Tab 鍵能立即看到該玩家的名稱，而不需要等待系統定時更新。

**優先級原因**: 這是核心需求，解決了現有系統中 Tab 補全反應遲鈍的問題，提升了使用者體驗。

**獨立測試方法**: 讓一名不在白名單內的測試玩家登入伺服器，另一名玩家立即嘗試使用 `/welcome <Tab>`，檢查是否能立即補全該玩家名稱。

**驗收場景 (Acceptance Scenarios)**:

1. **Given (已知)** 玩家 A 不在白名單內, **When (當)** 玩家 A 進入伺服器時, **Then (則)** 伺服器應檢測到 A 的訪問並將其加入補全快取。
2. **Given (已知)** 玩家 B 已在快取中, **When (當)** B 再次進入伺服器時, **Then (則)** 快取不應產生重複項。

---

### 使用者故事 2 - 自動過濾白名單玩家 (優先級: P2)

作為一名管理員，我希望快取機制能保持整潔，僅包含「需要被投票（非白名單）」的玩家，避免白名單內的玩家出現在補全清單中。

**優先級原因**: 減少無關資訊的干擾，確保補全功能的精準度。

**獨立測試方法**: 將一名已在快取中的玩家加入白名單，觀察該玩家是否從補全清單中消失（或在下次輸入時被過濾）。

**驗收場景**:

1. **Given** 玩家 C 已在白名單內, **When** C 進入伺服器時, **Then** C 的名稱不應被加入補全快取。

## 邊際情況 (Edge Cases)

- **伺服器重啟**: 快取僅存在於記憶體中，重啟後會清空。清空後將隨著非白名單玩家的登入重新動態建立。
- **快取容量限制**: 系統將保留 `autocomplete.max_players` 參數。當快取達到上限時，新的訪問者將取代最舊的快取項（採用 LRU 邏輯）。
- **玩家更名**: 由於快取以玩家名稱為鍵值，更名後的玩家將被視為新訪問者重新加入。

## 設定需求 (Configuration Requirements) *(必填)*

- **移除參數**: `autocomplete.update_interval` (因不再需要定時更新)。
- **保留參數**: `autocomplete.max_players` (預設 100，用於控制補全清單的最大長度)。

## 需求規格 (Requirements) *(必填)*

### Functional Requirements

- **FR-001**: 系統必須停止使用定時任務來更新玩家補全快取。
- **FR-002**: 系統必須監聽玩家進入伺服器的事件（PlayerJoinEvent）。
- **FR-003**: 當玩家進入伺服器時，系統必須檢查該玩家是否已在白名單內。
- **FR-004**: 若玩家不在白名單內且不在當前快取清單中，系統必須將其加入快取。
- **FR-005**: 系統必須確保快取操作是非同步執行的，以符合專案憲法原則（Async-First）。
- **FR-006**: 當玩家被加入白名單後，應從補全快取中移除該玩家。
- **FR-007**: 快取清單必須遵循 `autocomplete.max_players` 的限制，並在超出時自動移除舊項。
- **FR-008**: 系統啟動時，快取應初始化為空清單。

### Key Entities

- **Player Cache**: 存儲在記憶體中的玩家名稱清單，用於 Tab 補全。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 玩家登入後，補全快取的更新延遲應小於 1 秒。
- **SC-002**: 系統不再產生定時更新快取的非同步任務，減少 CPU 閒置開銷。
- **SC-003**: `/welcome <Tab>` 顯示的清單 100% 不包含已在白名單內的玩家。
